<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mabar3gem</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            10%, 30% { transform: scale(1.1); }
            20%, 40% { transform: scale(1.05); }
        }
        
        @keyframes crack {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-15deg) scale(1.1); }
            50% { transform: rotate(15deg) scale(1.15); }
            75% { transform: rotate(-10deg) scale(1.1); }
            100% { transform: rotate(0deg) scale(0); opacity: 0; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes diceRoll {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            100% { transform: rotateX(720deg) rotateY(720deg); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .animate-heartbeat { animation: heartbeat 0.8s ease-in-out; }
        .animate-crack { animation: crack 0.6s forwards; }
        .animate-slideup { animation: slideUp 0.5s ease-out; }
        .animate-diceroll { animation: diceRoll 0.5s ease-out; }
        .animate-bounce { animation: bounce 2s infinite; }
    </style>
</head>
<body class="bg-[#0d1117] min-h-screen">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const socket = io();
        
        function App() {
            const [guestName, setGuestName] = useState('');
            const [roomId, setRoomId] = useState('');
            const [inRoom, setInRoom] = useState(false);
            const [players, setPlayers] = useState([]);
            const [scores, setScores] = useState({});
            const [activeGame, setActiveGame] = useState('love');
            const [roomOwner, setRoomOwner] = useState('');
            
            const [name1, setName1] = useState('');
            const [name2, setName2] = useState('');
            const [loveResult, setLoveResult] = useState(null);
            const [loveLog, setLoveLog] = useState([]);
            const [showLoveResult, setShowLoveResult] = useState(false);
            
            const [fortune, setFortune] = useState(null);
            const [fortuneLog, setFortuneLog] = useState([]);
            const [isCracking, setIsCracking] = useState(false);
            const [showFortune, setShowFortune] = useState(false);
            
            const [numDice, setNumDice] = useState(1);
            const [diceSides, setDiceSides] = useState(6);
            const [diceResults, setDiceResults] = useState([]);
            const [activityLog, setActivityLog] = useState([]);
            const [showDice, setShowDice] = useState(false);
            const [canRoll, setCanRoll] = useState(true);
            
            useEffect(() => {
                socket.on('connected', (data) => setGuestName(data.guest_name));
                
                socket.on('room_created', (data) => {
                    setRoomId(data.room_id);
                    setInRoom(true);
                    setPlayers(data.players);
                    setRoomOwner(data.players[0]);
                    setScores({[data.players[0]]: 0});
                });
                
                socket.on('player_joined', (data) => {
                    setPlayers(data.players);
                    setScores(data.scores);
                    setInRoom(true);
                    if (data.players.length > 0) {
                        setRoomOwner(data.players[0]);
                    }
                });
                
                socket.on('player_left', (data) => {
                    setPlayers(data.players);
                    setScores(data.scores);
                    if (data.players.length > 0) {
                        setRoomOwner(data.players[0]);
                    }
                });
                
                socket.on('love_result', (data) => {
                    setLoveResult(data);
                    setShowLoveResult(true);
                    setLoveLog(prev => [{
                        player: data.player,
                        name1: data.name1,
                        name2: data.name2,
                        score: data.score,
                        time: new Date().toLocaleTimeString()
                    }, ...prev].slice(0, 10));
                });
                
                socket.on('fortune_result', (data) => {
                    setTimeout(() => {
                        setFortune(data);
                        setShowFortune(true);
                        setIsCracking(false);
                        setFortuneLog(prev => [{
                            player: data.player,
                            fortune: data.fortune,
                            category: data.category,
                            time: new Date().toLocaleTimeString()
                        }, ...prev].slice(0, 10));
                    }, 600);
                });
                
                socket.on('dice_rolled', (data) => {
                    setDiceResults(data.rolls);
                    setShowDice(true);
                    setScores(data.scores);
                    setActivityLog(prev => [{
                        player: data.player,
                        rolls: data.rolls,
                        total: data.total,
                        time: data.timestamp
                    }, ...prev].slice(0, 10));
                });
                
                socket.on('game_reset', () => {
                    setScores({});
                    setActivityLog([]);
                    setLoveLog([]);
                    setFortuneLog([]);
                    setLoveResult(null);
                    setFortune(null);
                    setDiceResults([]);
                    setShowLoveResult(false);
                    setShowFortune(false);
                    setShowDice(false);
                });
                
                socket.on('error', (data) => alert(data.message));
                
                return () => socket.removeAllListeners();
            }, [guestName]);
            
            const calculateLove = () => {
                if (name1.trim() && name2.trim()) {
                    setShowLoveResult(false);
                    setTimeout(() => {
                        socket.emit('love_calculate', { name1, name2 });
                    }, 100);
                }
            };
            
            const crackCookie = () => {
                if (isCracking) return;
                setIsCracking(true);
                setShowFortune(false);
                socket.emit('crack_cookie');
            };
            
            const rollDice = () => {
                if (!canRoll) return;
                setCanRoll(false);
                setShowDice(false);
                
                socket.emit('roll_dice', { 
                    num_dice: parseInt(numDice),
                    dice_sides: parseInt(diceSides)
                });
                
                setTimeout(() => setCanRoll(true), 1000);
            };
            
            const resetGame = () => {
                if (guestName === roomOwner) {
                    socket.emit('reset_game', { room_id: roomId });
                }
            };
            
            if (!inRoom) {
                return (
                    <div className="max-w-md mx-auto mt-10 p-4">
                        <div className="bg-[#161b22] border border-[#30363d] rounded-lg p-6">
                            <h1 className="text-2xl font-bold text-white mb-2">Mabar3gem</h1>
                            <p className="text-[#8b949e] mb-6 text-sm">Multiplayer Fun Tools</p>
                            
                            <div className="mb-6">
                                <div className="bg-[#0d1117] border border-[#30363d] rounded px-4 py-3 text-white text-center">
                                    {guestName || 'Connecting...'}
                                </div>
                            </div>
                            
                            <button 
                                onClick={() => socket.emit('create_room')}
                                className="w-full bg-[#238636] hover:bg-[#2ea043] text-white font-semibold py-3 px-4 rounded mb-3 transition"
                            >
                                Create Room
                            </button>
                            
                            <div className="relative my-4">
                                <div className="absolute inset-0 flex items-center">
                                    <div className="w-full border-t border-[#30363d]"></div>
                                </div>
                                <div className="relative flex justify-center text-xs">
                                    <span className="px-2 bg-[#161b22] text-[#8b949e]">or</span>
                                </div>
                            </div>
                            
                            <input 
                                type="text"
                                placeholder="Enter Room ID"
                                value={roomId}
                                onChange={(e) => setRoomId(e.target.value.toUpperCase())}
                                className="w-full bg-[#0d1117] border border-[#30363d] text-white rounded px-4 py-3 mb-3 focus:outline-none focus:border-[#58a6ff]"
                            />
                            <button 
                                onClick={() => roomId.trim() && socket.emit('join_room', { room_id: roomId })}
                                className="w-full bg-[#21262d] hover:bg-[#30363d] text-white font-semibold py-3 px-4 rounded transition"
                            >
                                Join Room
                            </button>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="max-w-7xl mx-auto p-4">
                    {/* Header */}
                    <div className="bg-[#161b22] border border-[#30363d] rounded-lg p-3 mb-4">
                        <div className="flex flex-wrap justify-between items-center gap-2 text-sm">
                            <div>
                                <span className="text-[#8b949e]">Room:</span>
                                <span className="text-white font-mono ml-1">{roomId}</span>
                            </div>
                            <div>
                                <span className="text-[#8b949e]">You:</span>
                                <span className="text-[#58a6ff] ml-1">{guestName}</span>
                                {guestName === roomOwner && <span className="ml-1 text-xs bg-[#238636] text-white px-2 py-0.5 rounded">üëë</span>}
                            </div>
                            <div>
                                <span className="text-[#8b949e]">Players:</span>
                                <span className="text-white ml-1">{players.length}/10</span>
                            </div>
                            {guestName === roomOwner && (
                                <button
                                    onClick={resetGame}
                                    className="bg-[#da3633] hover:bg-[#f85149] text-white px-3 py-1 rounded transition text-xs font-semibold"
                                >
                                    Reset
                                </button>
                            )}
                        </div>
                    </div>
                    
                    {/* Game Tabs */}
                    <div className="grid grid-cols-3 gap-2 mb-4">
                        {[
                            {id: 'love', label: 'üíï', name: 'Love'},
                            {id: 'fortune', label: 'ü•†', name: 'Cookie'},
                            {id: 'dice', label: 'üé≤', name: 'Dice'}
                        ].map(game => (
                            <button
                                key={game.id}
                                onClick={() => setActiveGame(game.id)}
                                className={`py-2 px-3 rounded font-semibold transition text-sm ${
                                    activeGame === game.id 
                                        ? 'bg-[#238636] text-white' 
                                        : 'bg-[#21262d] text-[#8b949e] hover:bg-[#30363d]'
                                }`}
                            >
                                {game.label} {game.name}
                            </button>
                        ))}
                    </div>
                    
                    <div className="grid md:grid-cols-3 gap-4">
                        {/* Game Area */}
                        <div className="md:col-span-2">
                            <div className="bg-[#161b22] border border-[#30363d] rounded-lg p-4">
                                {activeGame === 'love' && (
                                    <div>
                                        <h2 className="text-xl font-bold text-white mb-4">Love Calculator</h2>
                                        <div className="space-y-3">
                                            <input
                                                type="text"
                                                value={name1}
                                                onChange={(e) => setName1(e.target.value)}
                                                placeholder="Your name"
                                                className="w-full bg-[#0d1117] border border-[#30363d] text-white rounded px-3 py-2 focus:outline-none focus:border-[#58a6ff]"
                                            />
                                            <input
                                                type="text"
                                                value={name2}
                                                onChange={(e) => setName2(e.target.value)}
                                                placeholder="Partner name"
                                                className="w-full bg-[#0d1117] border border-[#30363d] text-white rounded px-3 py-2 focus:outline-none focus:border-[#58a6ff]"
                                            />
                                            <button
                                                onClick={calculateLove}
                                                className="w-full bg-[#238636] hover:bg-[#2ea043] text-white font-semibold py-2 px-4 rounded transition"
                                            >
                                                Calculate ‚ù§Ô∏è
                                            </button>
                                        </div>
                                        
                                        {showLoveResult && loveResult && (
                                            <div className="mt-4 text-center animate-slideup">
                                                <div className="text-5xl font-bold text-[#f85149] mb-2 animate-heartbeat">
                                                    {loveResult.score}%
                                                </div>
                                                <p className="text-[#8b949e] text-sm">
                                                    {loveResult.name1} üíï {loveResult.name2}
                                                </p>
                                            </div>
                                        )}
                                        
                                        {loveLog.length > 0 && (
                                            <div className="mt-4">
                                                <h3 className="text-white text-sm font-semibold mb-2">Match History</h3>
                                                <div className="space-y-1 max-h-48 overflow-y-auto">
                                                    {loveLog.map((log, i) => (
                                                        <div key={i} className="bg-[#0d1117] border border-[#30363d] rounded p-2 text-xs">
                                                            <span className="text-[#58a6ff]">{log.player}</span>
                                                            <span className="text-[#8b949e]"> matched </span>
                                                            <span className="text-white">{log.name1} & {log.name2}</span>
                                                            <span className="text-[#f85149] font-bold ml-2">{log.score}%</span>
                                                            <span className="text-[#8b949e] float-right">{log.time}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                {activeGame === 'fortune' && (
                                    <div>
                                        <h2 className="text-xl font-bold text-white mb-4">Fortune Cookie</h2>
                                        <div className="text-center py-6">
                                            <div 
                                                onClick={crackCookie}
                                                className={`text-7xl cursor-pointer inline-block select-none ${
                                                    isCracking ? 'animate-crack' : 'animate-bounce hover:scale-110 transition'
                                                }`}
                                            >
                                                ü•†
                                            </div>
                                            <p className="text-[#8b949e] mt-3 text-sm">Tap to crack!</p>
                                        </div>
                                        
                                        {showFortune && fortune && (
                                            <div className={`p-4 rounded-lg border-2 animate-slideup ${
                                                fortune.category === 'positive' 
                                                    ? 'bg-[#238636]/10 border-[#238636]' 
                                                    : fortune.category === 'negative'
                                                    ? 'bg-[#f85149]/10 border-[#f85149]'
                                                    : 'bg-[#d29922]/10 border-[#d29922]'
                                            }`}>
                                                <p className="text-white text-center">{fortune.fortune}</p>
                                            </div>
                                        )}
                                        
                                        {fortuneLog.length > 0 && (
                                            <div className="mt-4">
                                                <h3 className="text-white text-sm font-semibold mb-2">Fortune History</h3>
                                                <div className="space-y-1 max-h-48 overflow-y-auto">
                                                    {fortuneLog.map((log, i) => (
                                                        <div key={i} className={`border rounded p-2 text-xs ${
                                                            log.category === 'positive' ? 'bg-[#238636]/10 border-[#238636]' :
                                                            log.category === 'negative' ? 'bg-[#f85149]/10 border-[#f85149]' :
                                                            'bg-[#d29922]/10 border-[#d29922]'
                                                        }`}>
                                                            <div className="text-[#58a6ff] mb-1">{log.player}</div>
                                                            <div className="text-white">{log.fortune}</div>
                                                            <div className="text-[#8b949e] text-right mt-1">{log.time}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                {activeGame === 'dice' && (
                                    <div>
                                        <h2 className="text-xl font-bold text-white mb-4">Dice Roller</h2>
                                        <div className="flex gap-3 mb-3">
                                            <select
                                                value={numDice}
                                                onChange={(e) => setNumDice(e.target.value)}
                                                className="flex-1 bg-[#0d1117] border border-[#30363d] text-white rounded px-3 py-2 text-sm"
                                            >
                                                {[1,2,3,4,5,6].map(n => (
                                                    <option key={n} value={n}>{n} dice</option>
                                                ))}
                                            </select>
                                            <select
                                                value={diceSides}
                                                onChange={(e) => setDiceSides(e.target.value)}
                                                className="flex-1 bg-[#0d1117] border border-[#30363d] text-white rounded px-3 py-2 text-sm"
                                            >
                                                {[4,6,8,10,12,20].map(n => (
                                                    <option key={n} value={n}>D{n}</option>
                                                ))}
                                            </select>
                                        </div>
                                        
                                        <button
                                            onClick={rollDice}
                                            disabled={!canRoll}
                                            className="w-full bg-[#238636] hover:bg-[#2ea043] disabled:opacity-50 text-white font-semibold py-2 px-4 rounded transition"
                                        >
                                            {canRoll ? 'Roll üé≤' : 'Rolling...'}
                                        </button>
                                        
                                        {showDice && diceResults.length > 0 && (
                                            <div className="mt-4">
                                                <div className="flex gap-2 justify-center flex-wrap">
                                                    {diceResults.map((roll, i) => (
                                                        <div 
                                                            key={i}
                                                            className="w-14 h-14 bg-[#0d1117] border-2 border-[#58a6ff] rounded-lg flex items-center justify-center text-xl font-bold text-[#58a6ff] animate-diceroll"
                                                        >
                                                            {roll}
                                                        </div>
                                                    ))}
                                                </div>
                                                <p className="text-center text-[#238636] font-bold mt-3">
                                                    Total: {diceResults.reduce((a, b) => a + b, 0)}
                                                </p>
                                            </div>
                                        )}
                                        
                                        {activityLog.length > 0 && (
                                            <div className="mt-4">
                                                <h3 className="text-white text-sm font-semibold mb-2">Activity Log</h3>
                                                <div className="space-y-1 max-h-48 overflow-y-auto">
                                                    {activityLog.map((log, i) => (
                                                        <div key={i} className="bg-[#0d1117] border border-[#30363d] rounded p-2 text-xs">
                                                            <span className="text-[#58a6ff]">{log.player}</span>
                                                            <span className="text-[#8b949e]"> rolled </span>
                                                            <span className="text-white">[{log.rolls.join(', ')}]</span>
                                                            <span className="text-[#238636] font-bold ml-2">{log.total}</span>
                                                            <span className="text-[#8b949e] float-right">{log.time}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        {/* Scoreboard */}
                        <div className="bg-[#161b22] border border-[#30363d] rounded-lg p-4">
                            <h3 className="text-white font-semibold mb-3 text-sm">Scoreboard</h3>
                            <div className="space-y-2">
                                {players.map((player, i) => (
                                    <div 
                                        key={i}
                                        className={`p-2 rounded flex justify-between items-center text-sm ${
                                            player === guestName 
                                                ? 'bg-[#238636]/20 border border-[#238636]' 
                                                : 'bg-[#0d1117] border border-[#30363d]'
                                        }`}
                                    >
                                        <span className="text-white">
                                            {player}
                                            {player === roomOwner && ' üëë'}
                                        </span>
                                        <span className="text-[#58a6ff] font-bold">
                                            {scores[player] || 0}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>